<!DOCTYPE html>
<!--
copyright neil at neontribe.co.uk dec 2013
-->
<!--[if IE 7]>     <html class="ie ie7 lt-ie8 lt-ie9" dir="ltr"
lang="en-GB"> <![endif]-->
<!--[if IE 8]>     <html class="ie ie8 lt-ie9" dir="ltr" lang="en-GB">
<![endif]-->
<!--[if IE 9]>     <html class="ie ie9" dir="ltr" lang="en-GB"> <![endif]-->
<!--[if gt IE 9]>  <html dir="ltr" lang="en-GB"> <![endif]-->
<!--[if !IE]><!-->
<html dir="ltr" lang="en-GB"><!--<![endif]--><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <title>Graph input</title> 
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Graph Input">
        <link rel="stylesheet" href="" type="text/css" media="all">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">
        <style>
        
        </style>
    </head>
    <body class="no-js">
        <!--[if lt IE 9]>
        <section><h1>This is a warning that you are using an old browser, this page may not work as expected.</h1></section>    
        <![endif]-->
        <main>
            <h1>Use the graph to change values</h1>
            <button id="unlock">unlock graph</button>
            <div id="graph">If you do not have javascript enabled you will not see a graph here, but may use the form below.</div>
            
            <form id="form" tabindex="0">
                <fieldset>
                    <legend>Daily Temperature</legend>
                    <div>
                        <label for="time00">00</label>
                        <input type="number" name="time00" id="time00" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time01">01</label>
                        <input type="number" name="time01" id="time01" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time02">02</label>
                        <input type="number" name="time02" id="time02" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time03">03</label>
                        <input type="number" name="time03" id="time03" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time04">04</label>
                        <input type="number" name="time04" id="time04" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time05">05</label>
                        <input type="number" name="time05" id="time05" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time06">06</label>
                        <input type="number" name="time06" id="time06" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time07">07</label>
                        <input type="number" name="time07" id="time07" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time08">08</label>
                        <input type="number" name="time08" id="time08" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time09">09</label>
                        <input type="number" name="time09" id="time09" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time10">10</label>
                        <input type="number" name="time10" id="time10" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time11">11</label>
                        <input type="number" name="time11" id="time11" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time12">12</label>
                        <input type="number" name="time12" id="time12" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time13">13</label>
                        <input type="number" name="time13" id="time13" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time14">14</label>
                        <input type="number" name="time14" id="time14" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time15">15</label>
                        <input type="number" name="time15" id="time15" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time16">16</label>
                        <input type="number" name="time16" id="time16" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time17">17</label>
                        <input type="number" name="time17" id="time17" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time18">18</label>
                        <input type="number" name="time18" id="time18" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time19">19</label>
                        <input type="number" name="time19" id="time19" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time20">20</label>
                        <input type="number" name="time20" id="time20" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time21">21</label>
                        <input type="number" name="time21" id="time21" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time22">22</label>
                        <input type="number" name="time22" id="time22" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <div>
                        <label for="time23">23</label>
                        <input type="number" name="time23" id="time23" min="4" max="28" step="0.5" value="12"/>
                    </div>
                    <input type="submit" value="set"/>
                </fieldset>
            </form>
        </main>

    
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>    
    <script type="text/javascript">
        $('body').removeClass('no-js');
    </script>
    <script type="text/javascript">
    /*
    this is an example of a canvas graph input, it has an accessiblility fallback of using a form instead, this is also triggered if javascript is unavailable or fails.
    The form uses type=number, where this is not supported it should default to type=text, so remember to include suitable serverside validation. 
    */
    //hide form
    $('form fieldset').hide();
    
    //clear message for if javascript is not working
    $('#graph').text('');
    
    //add a use form instead of graph button and setup
    $('h1').after('<button id="useFormInstead" aria-controls="form" aria-expanded="false">use form instead</button>');
    $('h1').after('<button id="useGraphInstead" aria-controls="graph" aria-expanded="false">use graph instead</button>');
    $('#useGraphInstead').hide();
    $('#useFormInstead').on('click', function(evt) {
        $('#unlock').hide();
        $('form fieldset').show();
        $('#graph').hide();
        $('#useFormInstead').hide();    
        $('#useGraphInstead').show();
        $('form').focus();
    });
    $('#useGraphInstead').on('click', function(evt) {
        $('#unlock').show();
        $('form fieldset').hide();
        $('#graph').show();
        $('#useFormInstead').show();    
        $('#useGraphInstead').hide();
        $('#useFormInstead').focus();
    });
    
    //common canvas setup
    var font_height = 9,
        axis_width = 2,
        axis_colour = '#333',
        xPadding = 30,
        yPadding = 30,
        canvas_width = 550,
        canvas_height = 300,
        ctx = {},
        x = 0, //last position of mouse 
        y = 0, //used to distiguish click and move
        drawing = false, //set while mouse down, removed on mouse up
        temp_lines_colour = '#BBB',
        temp_lines_width = 1,
        line_colour = '#0F0',
        line_width = 3,
    //y-axis
        max_temp = 28,
        min_temp = 4,
        graph_temp_step = 2, //how often to draw horizontal grid lines
        //steps are in 0.5 degree intervals, to change read code and modify as required, remeber to also update the form input elements.
        touch_offset = yPadding, //pixels that the draw for touch happens above the touch point (so user can see what they are drawing
    //x-axis
        number_of_time_periods = 24; //should match form. names are timeXX
    //make and then insert a canvas
    var $newCanvas = $('<canvas/>')
                        .attr('id','canvas_for_graph')
                        .attr('height',canvas_height)
                        .attr('width',canvas_width),
        canvas_working = true,
        x_now = 0,
        y_now = 0,
        oversample = 4; //higher value = smoother and faster mouse movements
                        //work but higher cpu
    $('#graph').append($newCanvas);
    var canvas = document.getElementById('canvas_for_graph');
    
    if (canvas.getContext){
        ctx = canvas.getContext('2d');
        } else {
        // canvas-unsupported 
        canvas_working = false;
    }
    if ( !canvas_working ) {
        //canvas not working code to go here
        //eg show the form and a message
        $('#graph').text('Sorry but the graph cannot be shown. Please use the form instead or try a different browser.');     
    } 
    
    //keep track of the mouse every 100 milliseconds / double oversample number
    function getMousePosition() {
        // "one" attaches the handler to the event and removes it after it has executed once 
        $('#graph').one("mousemove", function (event) {
            x_now = event.pageX - $(this).position().left,
            y_now = event.pageY - $(this).position().top;
            // set a timeout so the handler will be attached again after a little while
            setTimeout(function() { getMousePosition(100/(2*oversample)) }, 100/(2*oversample));
        });
    }
    // start storing the mouse position 
    getMousePosition();
    
    var preventDefault = function(e){
        e.preventDefault();
    };
    
    //bind to unlock/set button 
    $('#unlock').on('click', function () {
        if ($('#unlock').text() === 'unlock graph') {
            //change button to set
            $('#unlock')
                .text('set');
            //bind draw on graph events
            //individual click triggers on mouse up
            $('#graph canvas').on('mouseup', click_to_set);
            $('#graph canvas').on('touchstart', touch_to_set);
            //click and drag triggers on mousedown and mouse move
            $('#graph canvas').on('mousedown', draw_to_set);
            $('#graph canvas').on('touchmove', touch_to_draw);
            //stop scrolling with touch on graph
            //$('#graph canvas').on('touchstart touchmove', preventDefault);
        } else if ($('#unlock').text() === 'set') {
            //change button to unlock
            $('#unlock')
                .text('unlock graph');
            //bind draw on graph events
            //individual click triggers on mouse up
            $('#graph canvas').off('mouseup', click_to_set);
            $('#graph canvas').off('touchstart', touch_to_set);
            //click and drag triggers on mousedown and mouse move
            $('#graph canvas').off('mousedown', draw_to_set);
            $('#graph canvas').off('touchmove', touch_to_draw);
            //$('#graph canvas').off('touchstart touchmove', preventDefault);
            /*
            TODO: whatever you wish when the set button is clicked, 
            default we do here is submit the form.
            */
            $('form').submit();
        }
    });
    
    var clear_graph = function () {
        ctx.setTransform(1, 0, 0, 1, 0, 0);        
        ctx.clearRect(0,0,canvas.width,canvas.height); 
    };
        
    var draw_graph = function () {
        //get values from inputs
        var temps = [],
            $inputs = $('fieldset div input');
        $inputs.each(function(temp) {
            temps[temps.length] = parseFloat($inputs[temp].value, 10);
        });
        //common canvas setup
        ctx.lineWidth = axis_width;
        ctx.strokeStyle = axis_colour;
        ctx.font = 'italic ' + font_height + 'pt sans-serif';
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        //draw graph axis
        ctx.beginPath();
        ctx.moveTo(xPadding, yPadding);
        ctx.lineTo(xPadding, canvas.height - yPadding );
        ctx.lineTo(canvas.width- xPadding, canvas.height - yPadding);
        ctx.stroke();
        //x-axis
        for(var i = 0; i < number_of_time_periods; i ++) {
            ctx.fillText(i.toString(), (canvas.width - xPadding*2)*i/(number_of_time_periods + 1) + xPadding *1.5, canvas.height - yPadding + font_height*2);
        }
        //y-axis (decreasing loop)
        for(var i = max_temp; i >=min_temp; i-=graph_temp_step) {
            //write key
            ctx.fillText(i.toString(),  10, (canvas.height - yPadding*2)*(max_temp - i) /((max_temp - min_temp)+1) + yPadding);
            //draw lines
            ctx.lineWidth = temp_lines_width;
            ctx.strokeStyle = temp_lines_colour ;
            ctx.beginPath();
            ctx.moveTo(xPadding + axis_width, (canvas.height - yPadding*2)*(max_temp - i) /((max_temp - min_temp)+1) + yPadding);
            ctx.lineTo(canvas.width - xPadding,(canvas.height - yPadding*2)*(max_temp - i) /((max_temp - min_temp)+1) + yPadding);
            ctx.stroke();
        }
        //draw graph line
        ctx.lineWidth = line_width;
        ctx.strokeStyle = line_colour;
        ctx.beginPath();
        
        for (var time in temps) {
            if (time === 0) {
                ctx.moveTo((canvas.width - xPadding*2)*time/25 + xPadding *1.5, (canvas.height - yPadding*2)*(max_temp - temps[0]) /((max_temp - min_temp)+1) + yPadding);
            } else {
                ctx.lineTo((canvas.width - xPadding*2)*time/25 + xPadding *1.5, (canvas.height - yPadding*2)*(max_temp - temps[time])/((max_temp - min_temp)+1) + yPadding);
            }
        }
        ctx.stroke();
    };
    //draw initial graph
    draw_graph();
    
    //listen to changes to form, then update graph
    $('input').on('input', function(e) {
        clear_graph();
        draw_graph();          
    });
    
    //listen to clicks on graph (mouse ups)
    var click_to_set = function(evt) {
        var x_now = evt.pageX - $(this).position().left,
            y_now = evt.pageY - $(this).position().top;
        drawing = false;
        set_graph_at_xy(x_now,y_now);
    };
    //listen to touchstart on graph 
    var touch_to_set = function(evt) {
        evt.preventDefault();
        //looks like touchstart does not contain x,y
        var x_now = evt.originalEvent.targetTouches[0].pageX - $(this).position().left,
            y_now = evt.originalEvent.targetTouches[0].pageY - $(this).position().top
        drawing = false;
        set_graph_at_xy(x_now,y_now - touch_offset);
    };
    var touch_to_draw = function(evt) {
        //alert('touch to draw');
        evt.preventDefault();
        var x_now = evt.originalEvent.targetTouches[0].pageX - $(this).position().left,
            y_now = evt.originalEvent.targetTouches[0].pageY - $(this).position().top;
        drawing = true;
        window.setTimeout(function() {draw_touch(x_now ,y_now);}, 100/oversample);
        set_graph_at_xy(x_now,y_now - touch_offset);
    };
    
    //listen to draw on graph (start mouse down then see if it moves)
    var draw_to_set = function(evt) {
        x = x_now;
        y = y_now;
        drawing = true;
        window.setTimeout(function() {draw(x,y);}, 100/oversample);
        set_graph_at_xy(x_now,y_now);
    };
    
    var draw = function (lastX, lastY) {
        //if mouse is down.
        if (drawing) {
            //get current x, y
            var temp_interval = 0.5,
                x_move_limit = (canvas.width - xPadding*2)/number_of_time_periods,
                y_move_limit = (canvas.height - yPadding*2)/((max_temp - min_temp)/temp_interval);    
            if ((Math.abs(x - x_now) >= x_move_limit/oversample) || (Math.abs(y - y_now) >= y_move_limit/oversample)) {
                //if move big enough check to set new graph values
                set_graph_at_xy(x_now,y_now);
                x = x_now;
                y = y_now;
            }
            //call timeout to this function again.
            window.setTimeout(function() {draw(x,y);}, 100/oversample);
            
        }     
    };
    var draw_touch = function (lastX, lastY) {
        //if mouse is down.
        if (drawing) {
            //set current x, y
            x = evt.touches[0].pageX - $(this).position().left;
            y = evt.touches[0].pageY - $(this).position().top;
            var temp_interval = 0.5,
                x_move_limit = (canvas.width - xPadding*2)/number_of_time_periods,
                y_move_limit = (canvas.height - yPadding*2)/((max_temp - min_temp)/temp_interval);    
            if ((Math.abs(x - lastX) >= x_move_limit/oversample) || (Math.abs(y - lastY) >= y_move_limit/oversample)) {
                //if move big enough check to set new graph values
                set_graph_at_xy(x,y);
            }
            //call timeout to this function again.
            window.setTimeout(function() {draw_touch(x,y);}, 100/oversample);
        }
    };
    var set_graph_at_xy = function (x, y) {
        //find which if any time period the click wass in (x-axis)
        var time_period = Math.round(((x - xPadding *1.5 )/ (canvas.width - xPadding*2) ) * (number_of_time_periods + 1));
        if (time_period >= number_of_time_periods){
            //padding makes graph wider, limit maximum time period value
            time_period = number_of_time_periods - 1;
        }
        if (time_period < 0 ){
            //padding makes graph wider, limit minimum time period value
            time_period = - 0;
        }
        //find tempurature based on horizontal value
        var selected_temp = max_temp - ((y - yPadding) * ((max_temp - min_temp)+1))/(canvas.height - yPadding*2);
        //round to nearest 0.5 degree
        selected_temp = Math.round(2 * selected_temp) /2;
        //limit range of selected_temp 
        if (selected_temp > max_temp) {
            selected_temp = max_temp;
        } else if (selected_temp < min_temp) {
            selected_temp = min_temp;
        }
        //set value in form and redraw graph
        var form_file_name = '';
        if (time_period < 10 ) {
            form_file_name = '#time0' + time_period.toString();
        } else {
            form_file_name = '#time' + time_period.toString();  
        }
        $(form_file_name).val(selected_temp);
        clear_graph();
        draw_graph();
    };
    </script>
    </body>
</html>